name: ops
services:
  app:
    build:
      context: /home/pmoise/sre-lab/app
      dockerfile: Dockerfile
    container_name: sre-lab-app
    hostname: sre-lab-app
    networks:
      sre-lab-net:
        aliases:
          - app
          - sre-lab-app
    restart: unless-stopped
  grafana:
    container_name: sre-lab-grafana
    depends_on:
      loki:
        condition: service_started
        required: true
      prometheus:
        condition: service_started
        required: true
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_SECURITY_ADMIN_USER: admin
    image: grafana/grafana:10.4.5
    networks:
      sre-lab-net: null
    ports:
      - mode: ingress
        target: 3000
        published: "3001"
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: volume
        source: grafana-data
        target: /var/lib/grafana
        volume: {}
      - type: bind
        source: /home/pmoise/sre-lab/ops/grafana/provisioning/datasources
        target: /etc/grafana/provisioning/datasources
        read_only: true
        bind:
          create_host_path: true
  loki:
    command:
      - -config.file=/etc/loki/loki-config.yml
    container_name: sre-lab-loki
    image: grafana/loki:2.9.8
    networks:
      sre-lab-net: null
    restart: unless-stopped
    volumes:
      - type: bind
        source: /home/pmoise/sre-lab/ops/loki-config.yml
        target: /etc/loki/loki-config.yml
        read_only: true
        bind:
          create_host_path: true
      - type: volume
        source: loki-data
        target: /loki
        volume: {}
  prometheus:
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    container_name: sre-lab-prometheus
    image: prom/prometheus:latest
    networks:
      sre-lab-net: null
    restart: unless-stopped
    volumes:
      - type: bind
        source: /home/pmoise/sre-lab/ops/prometheus.yml
        target: /etc/prometheus/prometheus.yml
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /home/pmoise/sre-lab/ops/alerts.yml
        target: /etc/prometheus/alerts.yml
        read_only: true
        bind:
          create_host_path: true
  promtail:
    command:
      - -config.file=/etc/promtail/promtail-config.yml
    container_name: sre-lab-promtail
    depends_on:
      loki:
        condition: service_started
        required: true
    image: grafana/promtail:2.9.8
    networks:
      sre-lab-net: null
    restart: unless-stopped
    volumes:
      - type: bind
        source: /home/pmoise/sre-lab/ops/promtail-config.yml
        target: /etc/promtail/promtail-config.yml
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
        read_only: true
        bind:
          create_host_path: true
      - type: bind
        source: /var/lib/docker/containers
        target: /var/lib/docker/containers
        read_only: true
        bind:
          create_host_path: true
networks:
  sre-lab-net:
    name: sre-lab-net
    driver: bridge
volumes:
  grafana-data:
    name: ops_grafana-data
  loki-data:
    name: ops_loki-data
